{% extends "base.html" %}
{% block title %}Detalle de Propiedad{% endblock %}
{% block content %}
    <h2 class="mb-4">Detalles de la Propiedad</h2>

    <div class="card mb-4">
        <div class="card-header">
            Información General
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>ID:</strong> {{ propiedad.id }}</li>
                        <li class="list-group-item"><strong>Nombre Casa:</strong> {{ propiedad.nombre_casa or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Dirección:</strong> {{ propiedad.direccion }}</li>
                        <li class="list-group-item"><strong>Ciudad:</strong> {{ propiedad.ciudad or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Tipo de Propiedad:</strong> {{ propiedad.tipo_propiedad or 'N/A' }}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Precio de Renta Base:</strong> ${{ propiedad.precio_renta_base }}</li>
                        <li class="list-group-item"><strong>Estado:</strong> <span class="badge bg-{{ 'success' if propiedad.estado == 'disponible' else ('warning' if propiedad.estado == 'en_mantenimiento' else 'info') }}">{{ propiedad.estado.capitalize() }}</span></li>
                        <li class="list-group-item"><strong>Fecha Disponible:</strong> {{ propiedad.fecha_disponible or 'N/A' }}</li>
                        <li class="list-group-item"><strong>Fecha de Creación:</strong> {{ propiedad.created_at.strftime('%Y-%m-%d %H:%M') if propiedad.created_at else 'N/A' }}</li>
                        <li class="list-group-item"><strong>Descripción:</strong> {{ propiedad.descripcion or 'N/A' }}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            {% if propiedad.estado == 'disponible' %}
                <a href="{{ url_for('asignar_contrato', propiedad_id=propiedad.id) }}" class="btn btn-success">Asignar Contrato</a>
            {% else %}
                <span class="text-muted">Esta propiedad ya tiene un contrato activo o no está disponible.</span>
            {% endif %}
        </div>
    </div>

    {# Contrato Actual #}
    <div class="card mb-4">
        <div class="card-header">
            Contrato Actual
        </div>
        <div class="card-body">
            {% if contrato_activo %}
                <p><strong>Inquilino:</strong> <a href="{{ url_for('inquilino_detalle', user_id=contrato_activo.inquilino.id) }}">{{ contrato_activo.inquilino.nombre_completo }}</a></p>
                <p><strong>Monto de Renta:</strong> ${{ "%.2f"|format(contrato_activo.monto_renta_mensual) }}</p>
                <p><strong>Duración:</strong> {{ contrato_activo.fecha_inicio.strftime('%d/%m/%Y') }} - {{ contrato_activo.fecha_fin.strftime('%d/%m/%Y') }}</p>

                <h5 class="mt-4">Plan de Pagos del Contrato</h5>
                {% if lista_meses %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th class="text-center">Estado del Pago</th>
                                    <th class="text-end">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mes in lista_meses %}
                                <tr>
                                    <td>{{ mes.nombre }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ 'success' if mes.estado == 'Pagado' else 'warning' }}">{{ mes.estado }}</span>
                                    </td>
                                    <td class="text-end">
                                        {% if mes.estado == 'Pagado' %}
                                            <button class="btn btn-secondary btn-sm" disabled>Pagado</button>
                                        {% else %}
                                            <a href="{{ url_for('registrar_pago', contrato_id=contrato_activo.id, mes=mes.param) }}" class="btn btn-primary btn-sm">Registrar Pago</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% else %}
                <p class="card-text">No hay ningún contrato activo para esta propiedad en este momento.</p>
            {% endif %}
        </div>
    </div>

    {# Historial de Contratos #}
    <div class="card mb-4">
        <div class="card-header">
            Historial de Contratos
        </div>
        <div class="card-body">
            {% if contratos_inactivos %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Inquilino</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Monto Mensual</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contrato in contratos_inactivos %}
                            <tr>
                                <td><a href="{{ url_for('inquilino_detalle', user_id=contrato.inquilino.id) }}">{{ contrato.inquilino.nombre_completo }}</a></td>
                                <td>{{ contrato.fecha_inicio.strftime('%d/%m/%Y') }}</td>
                                <td>{{ contrato.fecha_fin.strftime('%d/%m/%Y') }}</td>
                                <td>${{ "%.2f"|format(contrato.monto_renta_mensual) }}</td>
                                <td><span class="badge bg-secondary">{{ contrato.estado_contrato.capitalize() }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="card-text">No hay contratos anteriores para esta propiedad.</p>
            {% endif %}
        </div>
    </div>

    <div class="text-end mb-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Volver al Panel</a>
    </div>
{% endblock %}